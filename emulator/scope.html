<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.css">
</head>
<script type="text/javascript">

    function init() {
        canvas = document.getElementById('can');
        ctx = canvas.getContext("2d");
        w = canvas.width;
        h = canvas.height;
        //var imageData = ctx.getImageData(0, 0, w, h);

        var colorArray = [];
        function rgbValues2Int(r, g, b) {
            return ((r & 0xff) << 16) + ((g & 0xff) << 8) + (b & 0xff);
        }

        // for (var x = 10; x < 100; x++) {
        //     for (var y = 10; y < 100; y++) {
        //         //ctx.fillStyle = "rgba("+r+","+g+","+b+","+(a/255)+")";
        //         ctx.fillStyle = "red";
        //         ctx.fillRect(x, y, 1, 1);
        //     }
        // }

        var cnt = 0;
        console.log("at start");
        setInterval(() => {
            console.log("colorArray.length = " + colorArray.length);
            cnt = ++cnt % w;
            var fixedColorArray = colorArray;
            for (var y = 0; y < fixedColorArray.length; y++) {
                //ctx.fillStyle = "rgb(" + cnt % 255 + "," + y + ", 100)"
                //ctx.fillStyle = "red";
                let color = colorArray[y];
                let blue = color & 255;
                let green = ( color >> 8) & 255;
                let red = ( color >> 16) & 255;
                ctx.fillStyle = "rgb(" + red + "," + green + "," + blue + ")";
                //ctx.fillStyle = "red";
                ctx.fillRect(cnt, y + 10, 1, 1);
            }
        }, 50);

        var connection = new WebSocket('ws://localhost:8085');

        // When the connection is open, send some data to the server
        connection.onopen = function () {
            connection.send('Ping'); // Send the message 'Ping' to the server
        };

        // Log errors
        connection.onerror = function (error) {
            console.log('WebSocket Error ' + JSON.stringify(error));
        };

        // Log messages from the server
        connection.onmessage = function (e) {
            //console.log('Server: ' + e.data);
            var data = JSON.parse(e.data);
            var newArray = [];
            for (var i = 0; ; i++) {
                if (data[i] === undefined) break;
                newArray.push(data[i]);
            }
            //console.log("newArray = " + JSON.stringify(newArray));
            colorArray = newArray;
        };

        setInterval(() => {
            console.log("sending");
            connection.send('Heartbeat');
        }, 1000);


    }
</script>
<body onload="init()">
    <div class="container">
        <div class="row mt-5">
            <input type="button" class="btn btn-primary btn-block" value="Button" id="clr" size="23" onclick="erase()"/>
        </div>
        <div class="row mt-1">
            <canvas id="can" width="400" height="400"></canvas>
        </div>
    </div>
</body>
</html>